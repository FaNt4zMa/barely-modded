name: GitHub & Modrinth Release - Server

on:
  push:
    tags:
      - 'server/v*'

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: |
          TAG="${{ github.ref_name }}"
          VERSION="${TAG#server/v}"
          echo "number=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Install packwiz
        run: |
          wget -q https://nightly.link/packwiz/packwiz/workflows/go/main/Linux%2064-bit%20x86.zip -O packwiz.zip
          unzip packwiz.zip
          chmod +x packwiz
          sudo mv packwiz /usr/local/bin/

      - name: Load pack config
        id: config
        run: |
          PACK_NAME=$(yq '.server.pack_name' pack-config.yml)
          MODRINTH_ID=$(yq '.server.modrinth_id' pack-config.yml)
          MODRINTH_SLUG=$(yq '.server.modrinth_slug' pack-config.yml)
          MINECRAFT_VERSION=$(yq '.server.minecraft_version' pack-config.yml)
          LOADER_VERSION=$(yq '.server.loader_version' pack-config.yml)
          LOADER=$(yq '.server.loader' pack-config.yml)

          echo "pack_name=$PACK_NAME" >> $GITHUB_OUTPUT
          echo "modrinth_id=$MODRINTH_ID" >> $GITHUB_OUTPUT
          echo "modrinth_slug=$MODRINTH_SLUG" >> $GITHUB_OUTPUT
          echo "minecraft_version=$MINECRAFT_VERSION" >> $GITHUB_OUTPUT
          echo "loader_version=$LOADER_VERSION" >> $GITHUB_OUTPUT
          echo "loader=$LOADER" >> $GITHUB_OUTPUT

      - name: Process custom datapacks
        working-directory: server-pack
        run: |
          # Check if custom datapacks are configured
          DATAPACK_COUNT=$(yq '.server.custom_datapacks // [] | length' ../pack-config.yml)
          
          if [ "$DATAPACK_COUNT" -gt 0 ]; then
            echo "Processing custom datapacks..."
            
            # Backup .packwizignore if it exists
            if [ -f .packwizignore ]; then
              cp .packwizignore .packwizignore.bak
            fi
            
            # Process each datapack
            for i in $(seq 0 $((DATAPACK_COUNT - 1))); do
              FOLDER=$(yq ".server.custom_datapacks[$i].folder" ../pack-config.yml)
              VERSION=$(yq ".server.custom_datapacks[$i].version" ../pack-config.yml)
              
              if [ -d "datapacks/$FOLDER" ]; then
                echo "  ✓ Zipping $FOLDER -> $FOLDER-v$VERSION.zip"
                
                # Zip the folder
                cd "datapacks/$FOLDER"
                zip -r "../$FOLDER-v$VERSION.zip" .
                cd ../..
                
                # Add folder to .packwizignore temporarily
                echo "datapacks/$FOLDER/" >> .packwizignore
              else
                echo "  ⚠ Skipping $FOLDER (folder not found)"
              fi
            done
          else
            echo "No custom datapacks configured"
          fi

      - name: Export modpack
        working-directory: server-pack
        run: |
          VERSION="${{ steps.version.outputs.number }}"
          
          # Update placeholders
          sed -i "s/<MODPACKVERSION>/$VERSION/g" pack.toml
          sed -i "s/<PACKNAME>/${{ steps.config.outputs.pack_name }}/g" pack.toml
          sed -i "s/<MINECRAFTVERSION>/${{ steps.config.outputs.minecraft_version }}/g" pack.toml
          sed -i "s/<FABRICVERSION>/${{ steps.config.outputs.loader_version }}/g" pack.toml
          sed -i "s/<PROJECTID>/${{ steps.config.outputs.modrinth_id }}/g" config/simpleupdatechecker_modpack.json
          sed -i "s/<PACKNAME>/${{ steps.config.outputs.pack_name }}/g" config/simpleupdatechecker_modpack.json
          sed -i "s/<MODPACKVERSION>/$VERSION/g" config/simpleupdatechecker_modpack.json
          
          # Refresh and export
          packwiz refresh
          
          # Create export directory
          mkdir -p export/v$VERSION
          
          # Export to .mrpack
          packwiz modrinth export --output "export/v$VERSION/barely-modded-server-$VERSION.mrpack"

      - name: Extract latest changelog entry
        id: changelog
        run: |
          cd server-pack
          awk '/^## /{if (NR>1) exit} {print}' changelog.md > ../latest_changelog.txt
          cd ..
          {
            echo "body<<EOF"
            cat latest_changelog.txt
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: "${{ steps.config.outputs.pack_name }} v${{ steps.version.outputs.number }}"
          body: ${{ steps.changelog.outputs.body }}
          files: "server-pack/export/v${{ steps.version.outputs.number }}/barely-modded-server-${{ steps.version.outputs.number }}.mrpack"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish to Modrinth
        uses: Kir-Antipov/mc-publish@v3
        with:
          modrinth-id: ${{ steps.config.outputs.modrinth_id }}
          modrinth-token: ${{ secrets.MODRINTH_TOKEN }}
          files: "server-pack/export/v${{ steps.version.outputs.number }}/barely-modded-server-${{ steps.version.outputs.number }}.mrpack"
          name: "${{ steps.config.outputs.pack_name }} v${{ steps.version.outputs.number }}"
          version: ${{ steps.version.outputs.number }}
          version-type: release
          changelog: |
            # [Download the server jar!](https://mrpack4server.pb4.eu/download/${{ steps.config.outputs.modrinth_slug }}/${{ steps.version.outputs.number }}/jvm21/server.jar)
            ---
            
            ${{ steps.changelog.outputs.body }}
            
            ---
            *This release was automatically published via GitHub Actions*
          loaders: ${{ steps.config.outputs.loader }}
          game-versions: ${{ steps.config.outputs.minecraft_version }}
      
      - name: Update Modrinth project description
        run: |
          DESCRIPTION=$(jq -Rs . < server-pack/readme.md)

          curl -X PATCH "https://api.modrinth.com/v2/project/${{ steps.config.outputs.modrinth_id }}" \
            -H "Authorization: Bearer ${{ secrets.MODRINTH_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "{\"body\": $DESCRIPTION}"
