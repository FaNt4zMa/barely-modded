name: Modrinth Release - Server

on:
  release:
    types: [published]

permissions:
  contents: read

jobs:
  upload:
    if: startsWith(github.event.release.tag_name, 'server/')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: |
          TAG="${{ github.event.release.tag_name }}"
          VERSION="${TAG#server/v}"
          echo "number=$VERSION" >> $GITHUB_OUTPUT

      - name: Load pack config
        id: config
        run: |
          MODRINTH_ID=$(yq '.server.modrinth_id' pack-config.yml)
          MODRINTH_SLUG=$(yq '.server.modrinth_slug' pack-config.yml)
          MINECRAFT_VERSION=$(yq '.server.minecraft_version' pack-config.yml)
          LOADER=$(yq '.server.loader' pack-config.yml)
          
          echo "modrinth_id=$MODRINTH_ID" >> $GITHUB_OUTPUT
          echo "modrinth_slug=$MODRINTH_SLUG" >> $GITHUB_OUTPUT
          echo "minecraft_version=$MINECRAFT_VERSION" >> $GITHUB_OUTPUT
          echo "loader=$LOADER" >> $GITHUB_OUTPUT

      - name: Download release asset
        run: |
          gh release download ${{ github.event.release.tag_name }} \
            -p "barely-modded-server-${{ steps.version.outputs.number }}.mrpack"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish to Modrinth
        uses: Kir-Antipov/mc-publish@v3
        with:
          modrinth-id: ${{ steps.config.outputs.modrinth_id }}
          modrinth-token: ${{ secrets.MODRINTH_TOKEN }}
          files: "barely-modded-server-${{ steps.version.outputs.number }}.mrpack"
          name: ${{ github.event.release.name }}
          version: ${{ steps.version.outputs.number }}
          version-type: release
          changelog: |
            # [Download the server jar!](https://mrpack4server.pb4.eu/download/${{ steps.config.outputs.modrinth_slug }}/${{ steps.version.outputs.number }}/jvm21/server.jar)
            ---
            
            ${{ github.event.release.body }}
            
            ---
            *This release was automatically published via GitHub Actions*
          loaders: ${{ steps.config.outputs.loader }}
          game-versions: ${{ steps.config.outputs.minecraft_version }}
      
      - name: Update Modrinth project description
        run: |
          DESCRIPTION=$(jq -Rs . < server-pack/readme.md)

          curl -X PATCH "https://api.modrinth.com/v2/project/${{ steps.config.outputs.modrinth_id }}" \
            -H "Authorization: ${{ secrets.MODRINTH_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "{\"body\": $DESCRIPTION}"